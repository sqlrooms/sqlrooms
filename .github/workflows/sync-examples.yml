name: Sync Examples

on:
  # push:
  #   branches: [main]
  #   paths:
  #     - 'examples/**'
  #     - 'docs/media/examples/**'
  #     - '.github/workflows/sync-examples.yml'
  workflow_dispatch:
    inputs:
      build_examples:
        description: Run the examples build workflow before syncing
        type: boolean
        default: false

jobs:
  build-examples:
    if: ${{ inputs.build_examples }}
    uses: ./.github/workflows/build-examples.yml

  sync:
  sync:
    needs: [build-examples]
    if: ${{ always() && (!inputs.build_examples || needs.build-examples.result == 'success') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v6
        with:
          path: source
          lfs: true # Enable LFS for the checkout

      - name: Install Git LFS for source
        run: |
          sudo apt-get install -y git-lfs
          git lfs install

      - name: Setup target repository
        run: |
          # Initialize a new repository
          mkdir -p target
          cd target
          git init
          git remote add origin https://${{ secrets.EXAMPLES_PAT }}@github.com/sqlrooms/examples.git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Create an initial empty commit and check out main branch
          git checkout -b main

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Sync examples and media
        run: |
          # Create target directories
          mkdir -p target/media/examples

          # Copy examples directory
          cp -r source/examples/* target/

          # Copy images from docs/media/examples if it exists
          if [ -d "source/docs/media/examples" ]; then
            cp -r source/docs/media/examples/* target/media/examples/
          fi

          # Copy examples documentation as README.md
          cp source/docs/examples.md target/README.md
          # Remove only the frontmatter from README
          sed -i.bak '1{/---/{:a N;/\n---/!ba};d}' target/README.md
          rm target/README.md.bak

          # Ensure each example has a default netlify.toml
          for dir in target/*; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              NETLIFY_FILE="$dir/netlify.toml"
              if [ ! -f "$NETLIFY_FILE" ]; then
                cat <<'EOF' > "$NETLIFY_FILE"
          [build]
            command = "npm run build"
            publish = "dist"

          [build.environment]
            NODE_VERSION = "24.11.1"
            NODE_OPTIONS = "--max_old_space_size=4096"
            NPM_FLAGS = "--force"  # Override dependency constraints
            CI = "false"  # This will prevent treating warnings as errors

          EOF
              fi
            fi
          done

          # Get version from lerna.json
          VERSION=$(jq -r '.version' source/lerna.json)

          # Update package.json files
          find target -name "package.json" -type f | while read -r file; do
            # Replace all "@sqlrooms/*": "workspace:*" with "@sqlrooms/*": "$VERSION"
            jq --arg version "$VERSION" \
              '(.dependencies | with_entries(
                if .key | startswith("@sqlrooms/")
                then .value = $version
                else .
                end
              )) as $deps
              | .dependencies = $deps' "$file" > temp.json
            mv temp.json "$file"
          done

          # Generate lockfiles for each example
          find target -name "package.json" -type f | while read -r file; do
            dir=$(dirname "$file")
            # Skip if it's a nested node_modules
            if [[ ! "$dir" =~ node_modules ]]; then
              echo "Generating lockfile for $dir"
              cd "$dir"
              npm install --package-lock-only --legacy-peer-deps
              cd - > /dev/null
            fi
          done

          # Setup git config and commit changes
          cd target

          # Add all changes
          git add .

          # Commit changes
          git commit -m "Sync examples from main repo (${GITHUB_SHA})"

          # Force push to overwrite git history
          git push -f origin main
