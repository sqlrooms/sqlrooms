name: NPM Publish

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - prerelease
          - patch
          - minor
          - major
          - auto
      preid:
        description: 'Prerelease identifier'
        required: false
        default: 'rc'
        type: string
      prerelease_bump:
        description: 'Prerelease bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    # only run publish if run manually or if commit starts with one of "feat|fix"
    if: ${{ github.event_name == 'workflow_dispatch' || startsWith(github.event.head_commit.message, 'feat:') || startsWith(github.event.head_commit.message, 'fix:')}}
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          scope: '@sqlrooms'

      - name: Install dependencies
        # See https://github.com/pnpm/pnpm/issues/8840
        run: pnpm install --shamefully-hoist

      - name: Configure NPM
        run: |
          # Configure npm for the organization scope
          npm config set @sqlrooms:registry https://registry.npmjs.org/
          npm config set //registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}
          # Ensure packages are published as public
          echo "access=public" >> .npmrc

      - name: Build packages
        run: pnpm build

      - name: Bump prerelease version
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.version == 'prerelease' }}
        run: |
          bump=${{ inputs.prerelease_bump != '' && inputs.prerelease_bump || 'patch' }}
          if [ "$bump" = "minor" ]; then
            cmd="preminor"
          elif [ "$bump" = "major" ]; then
            cmd="premajor"
          else
            cmd="prerelease"
          fi
          pnpm exec lerna version "$cmd" --conventional-commits --yes --sync-workspace-lock --preid=${{ inputs.preid != '' && inputs.preid || 'rc' }} --no-push
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PREID: ${{ inputs.preid != '' && inputs.preid || 'rc' }}
          PRERELEASE_BUMP: ${{ inputs.prerelease_bump != '' && inputs.prerelease_bump || 'patch' }}

      - name: Bump version
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.version == 'prerelease') }}
        run: |
          version_input=${{ github.event_name == 'workflow_dispatch' && inputs.version || 'auto' }}
          if [ "$version_input" = "auto" ]; then
            pnpm exec lerna version --conventional-commits --yes --sync-workspace-lock --no-push
          else
            pnpm exec lerna version "$version_input" --yes --sync-workspace-lock --no-push
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Publish prerelease
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.version == 'prerelease' }}
        run: pnpm publish-prerelease

      - name: Publish
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.version == 'prerelease') }}
        run: pnpm publish-release

      - name: Push version commit and tags
        if: ${{ success() }}
        run: |
          git push origin HEAD:${{ github.ref_name }}
          git push origin --tags

      - name: Create GitHub release
        if: ${{ success() }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          tag=$(git describe --abbrev=0 --tags)
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Release $tag already exists, skipping"
            exit 0
          fi
          heading_tag="${tag#v}"
          notes=$(awk -v t="$heading_tag" '
            BEGIN { in_section = 0 }
            /^##?[[:space:]]*\[?([vV]?){0,1}/ {
              # start of a heading
              if (in_section) exit;
            }
            /^##?[[:space:]]*\[?([vV]?){0,1}/ && $0 ~ t {
              in_section = 1; next;
            }
            in_section { print }
          ' CHANGELOG.md)
          if [ -z "$notes" ]; then
            notes="Automated release from npm publish workflow."
          fi
          notes_file=$(mktemp)
          printf "%s\n" "$notes" > "$notes_file"
          prerelease_flag=""
          if [[ "$tag" == *"-"* ]]; then
            prerelease_flag="--prerelease"
          fi
          gh release create "$tag" --title "$tag" --notes-file "$notes_file" ${prerelease_flag}
